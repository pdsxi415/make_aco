name: Build and Deploy make_aco

on:
  push:
    branches:
      - main

env:
  REPO_URL: https://git.dogni.work/xiaohei/make_aco.git

jobs:
  build:
    name: Build make_aco
    runs-on: ubuntu-22.04
    steps:
      - name: å…‹éš†ä»£ç ä»“åº“
        run: |
          echo "æ­£åœ¨å…‹éš†ä»£ç ä»“åº“..."
          git clone $REPO_URL $GITHUB_WORKSPACE  # é»˜è®¤å…‹éš†åˆ°å½“å‰å·¥ä½œç›®å½•          

      - name: æ£€æŸ¥ Node.js ç‰ˆæœ¬
        run: |
          echo "å½“å‰ä½¿ç”¨çš„ Node.js ç‰ˆæœ¬æ˜¯ï¼š"
          node -v
          npm -v          

      - name: è®¾ç½® NPM é•œåƒä¸ºé˜¿é‡Œäº‘
        run: |
          echo "æ­£åœ¨è®¾ç½® NPM é•œåƒæºä¸ºé˜¿é‡Œäº‘..."
          npm config set registry https://registry.npm.taobao.org          

      - name: å®‰è£…ä¾èµ–
        run: |
          echo "æ­£åœ¨å®‰è£…ä¾èµ–..."
          cd $GITHUB_WORKSPACE
          npm install          

      - name: æ„å»ºé¡¹ç›®
        run: |
          echo "æ­£åœ¨æ„å»ºç½‘ç«™..."
          npm run build
          echo "æ„å»ºå®Œæˆï¼Œåˆ—å‡º dist ç›®å½•å†…å®¹ï¼š"
          ls -l $GITHUB_WORKSPACE/dist  # ç¡®è®¤ dist ç›®å½•å†…å®¹
          ls
          pwd          

  deploy:
    name: Deploy make_aco
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - name: å®‰è£… lftp
        run: |
          echo "å®‰è£… lftp å·¥å…·..."
          sed -i 's|http://deb.debian.org|http://mirrors.aliyun.com|g' /etc/apt/sources.list
          apt-get update && apt-get install -y lftp          
      - name: ğŸ“‚ Sync files
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: 10.0.4.14
          username: ubuntu
          password: wxx2936554@
          local-dir: ./
          server-dir: ./
          log-level: verbose    

      - name: ç¡®è®¤ä¸Šä¼ å®Œæˆ
        run: |
          echo "ç¡®è®¤ä¸Šä¼ æ–‡ä»¶æ˜¯å¦æˆåŠŸ..."
          lftp -c "
          open -u $FTP_USER,$FTP_PASS $FTP_HOST;
          ls $FTP_TARGET_DIR;
          bye;"          
